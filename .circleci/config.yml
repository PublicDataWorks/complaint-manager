version: 2
jobs:
    test:
        docker:
          - image: kkarczmarczyk/node-yarn
            environment:
              NODE_ENV: test
          - image: postgres:10.1-alpine
            environment:
              POSTGRES_PASSWORD: password
              POSTGRES_DB: complaint-manager-test
        steps:
          - checkout
          - run:
              name: Install Dependencies
              command: yarn install
          - run:
              name: Run client tests
              command: yarn test:client
          - run:
              name: Run server tests
              command: yarn test:server --forceExit
              environment:
                NEW_RELIC_ENABLED: false
                NEW_RELIC_NO_CONFIG_FILE: true


    security-check:
        docker:
          - image: docker:stable
        steps:
          - checkout
          - setup_remote_docker
          - run:
              name: Run Security Checks
              command: ./scripts/security-checks.sh

    build-and-publish:
        docker:
          - image: docker:stable
        steps:
          - checkout
          - setup_remote_docker
          - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
          - run: docker build --build-arg REACT_ENV=development_ci -t noipm/complaint-manager-development:$CIRCLE_SHA1 .
          - run: docker build --build-arg REACT_ENV=staging -t noipm/complaint-manager-staging:$CIRCLE_SHA1 .
          - run: docker build --build-arg REACT_ENV=production -t noipm/complaint-manager-production:$CIRCLE_SHA1 .
          - run: docker push noipm/complaint-manager-development:$CIRCLE_SHA1
          - run: docker push noipm/complaint-manager-staging:$CIRCLE_SHA1
          - run: docker push noipm/complaint-manager-production:$CIRCLE_SHA1

    deploy-development:
            docker:
              - image: noipm/docker-heroku:7.0.65
            steps:
              - setup_remote_docker
              - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
              - run: docker pull noipm/complaint-manager-development:$CIRCLE_SHA1
              - run:
                  name: Migrate and Seed DB
                  command: |
                    docker run \
                    -e NODE_ENV=development_ci \
                    -e DATABASE_USERNAME=$DEVELOPMENT_DATABASE_USERNAME \
                    -e DATABASE_PASS=$DEVELOPMENT_DATABASE_PASS \
                    -e DATABASE_NAME=$DEVELOPMENT_DATABASE_NAME \
                    -e DATABASE_HOST=$DEVELOPMENT_DATABASE_HOST \
                    -e AWS_ACCESS_KEY_ID=$DEVELOPMENT_AWS_ACCESS_KEY_ID \
                    -e AWS_SECRET_ACCESS_KEY=$DEVELOPMENT_AWS_SECRET_ACCESS_KEY \
                    noipm/complaint-manager-development:$CIRCLE_SHA1 yarn setup:db

              - run: docker login --username=$HEROKU_USER --password=$HEROKU_API_KEY
              - run: docker tag noipm/complaint-manager-development:$CIRCLE_SHA1 registry.heroku.com/noipm-development/web
              - run: docker push registry.heroku.com/noipm-development/web
              - run: heroku container:release web --app noipm-development

    ensure-development-deploy-succeeded:
          docker:
            - image: alpine:latest
          steps:
            - checkout
            - run: scripts/ensure-deploy-succeeded.sh https://noipm-development.herokuapp.com/health-check

    e2e-testing:
            docker:
              - image: noipm/nightwatch-chrome:latest
            steps:
              - checkout
              - run:
                  name: Run E2E tests
                  command: cd e2e && nightwatch --env $ENVIRONMENT
              - store_artifacts:
                  path: e2e/tests/userJourney

    deploy-staging:
        docker:
          - image: noipm/docker-heroku:7.0.65
        steps:
          - setup_remote_docker
          - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
          - run: docker pull noipm/complaint-manager-staging:$CIRCLE_SHA1
          - run: heroku maintenance:on --app noipm-staging
          - run:
              name: Migrate and Seed DB
              command: |
                docker run \
                -e NODE_ENV=staging \
                -e DATABASE_USERNAME=$STAGING_DATABASE_USERNAME \
                -e DATABASE_PASS=$STAGING_DATABASE_PASS \
                -e DATABASE_NAME=$STAGING_DATABASE_NAME \
                -e DATABASE_HOST=$STAGING_DATABASE_HOST \
                -e AWS_ACCESS_KEY_ID=$STAGING_AWS_ACCESS_KEY_ID \
                -e AWS_SECRET_ACCESS_KEY=$STAGING_AWS_SECRET_ACCESS_KEY \
                noipm/complaint-manager-staging:$CIRCLE_SHA1 yarn setup:db

          - run: docker login --username=$HEROKU_USER --password=$HEROKU_API_KEY registry.heroku.com
          - run: docker tag noipm/complaint-manager-staging:$CIRCLE_SHA1 registry.heroku.com/noipm-staging/web
          - run: docker push registry.heroku.com/noipm-staging/web
          - run: heroku container:release web --app noipm-staging
          - run: heroku maintenance:off --app noipm-staging

    ensure-staging-deploy-succeeded:
      docker:
        - image: alpine:latest
      steps:
        - checkout
        - run: scripts/ensure-deploy-succeeded.sh https://noipm-staging.herokuapp.com/health-check

    deploy-production:
        docker:
          - image: noipm/docker-heroku:7.0.65
        steps:
          - setup_remote_docker
          - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
          - run: docker pull noipm/complaint-manager-production:$CIRCLE_SHA1
          - run: heroku maintenance:on --app noipm-production
          - run:
              name: Migrate production database
              command: |
                docker run \
                -e NODE_ENV=production \
                -e DATABASE_USERNAME=$PRODUCTION_DATABASE_USERNAME \
                -e DATABASE_PASS=$PRODUCTION_DATABASE_PASS \
                -e DATABASE_NAME=$PRODUCTION_DATABASE_NAME \
                -e DATABASE_HOST=$PRODUCTION_DATABASE_HOST \
                -e AWS_ACCESS_KEY_ID=$PRODUCTION_AWS_ACCESS_KEY_ID \
                -e AWS_SECRET_ACCESS_KEY=$PRODUCTION_AWS_SECRET_ACCESS_KEY \
                noipm/complaint-manager-production:$CIRCLE_SHA1 yarn setup:db
          - run: docker login --username=$HEROKU_USER --password=$HEROKU_API_KEY registry.heroku.com
          - run: docker tag noipm/complaint-manager-production:$CIRCLE_SHA1 registry.heroku.com/noipm-production/web
          - run: docker push registry.heroku.com/noipm-production/web
          - run: heroku container:release web --app noipm-production
          - run: heroku maintenance:off --app noipm-production

    ensure-production-deploy-succeeded:
      docker:
        - image: alpine:latest
      steps:
        - checkout
        - run: scripts/ensure-deploy-succeeded.sh https://noipm-production.herokuapp.com/health-check

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - test
      - security-check:
          requires:
            - test
      - build-and-publish:
          requires:
            - security-check
      - deploy-development:
          requires:
            - build-and-publish
      - ensure-development-deploy-succeeded:
          requires:
            - deploy-development
      - e2e-testing:
          requires:
            - ensure-development-deploy-succeeded
      - hold-for-staging:
          type: approval
          requires:
            - e2e-testing
      - deploy-staging:
          requires:
            - hold-for-staging
      - ensure-staging-deploy-succeeded:
          requires:
            - deploy-staging
      - hold-for-production:
          type: approval
          requires:
            - ensure-staging-deploy-succeeded
      - deploy-production:
          requires:
            - hold-for-production
      - ensure-production-deploy-succeeded:
          requires:
            - deploy-production
