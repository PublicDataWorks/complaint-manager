version: 2
jobs:
    test:
        docker:
          - image: kkarczmarczyk/node-yarn
        steps:
          - checkout
          - run:
              name: Install Dependencies
              command: yarn install
          - run:
              name: Run Tests
              command: yarn test

    build-and-publish:
        docker:
          - image: docker:stable
        steps:
          - checkout
          - setup_remote_docker
          - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
          - run: docker build -t noipm/complaint-manager .
          - run: docker push noipm/complaint-manager

    deploy-staging:
        docker:
          - image: docker:stable
        steps:
          - setup_remote_docker
          - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD && echo 'logged in'
          - run: docker pull noipm/complaint-manager && echo 'pulled'
          - run: docker login --username=$HEROKU_USER --password=$HEROKU_API_KEY registry.heroku.com
          - run: docker tag noipm/complaint-manager registry.heroku.com/noipm-staging/web
          - run: docker push registry.heroku.com/noipm-staging/web

#
#   deploy-to-staging:
#      docker:
#        - image: circleci/node:latest
#
#      steps:
#         - checkout
#         - run:
#            name: TEST
#            command: scripts/test.sh
#
#   e2e-testing:
#      docker:
#         - image: circleci/node:latest
#
#      steps:
#         - checkout
#         - run:
#            name: TEST
#            command: scripts/test.sh
#
#   deploy-to-prod:
#      docker:
#        - image: circleci/node:latest
#
#      steps:
#         - checkout
#         - run:
#            name: TEST
#            command: scripts/test.sh
# Old jobs
###############
#  build:
#    docker:
#      - image: circleci/ruby:2.4.1-node
#
#    steps:
#      - checkout
#      - run:
#          command: scripts/pipeline/build-and-test.sh
#
#  deploy-to-staging:
#    machine:
#        enabled: true
#    working_directory: ~/complaint-manager
#    steps:
#      - checkout
#      - run:
#          name: Set up Heroku
#          command: bash ./scripts/setup-heroku.sh
#      - run:
#          name: Deploy Master to Heroku
#          command:
#            git push heroku master

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - test
      - build-and-publish:
          requires:
            - test
      - deploy-staging:
          requires:
            - build-and-publish
#      - e2e-testing:
#          requires:
#            - deploy-to-staging
#      - deploy-to-prod:
#          type: approval
#          requires:
#            - e2e-testing
#
