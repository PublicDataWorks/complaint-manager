version: 2
jobs:
    test:
        docker:
          - image: kkarczmarczyk/node-yarn
            environment:
              NODE_ENV: test
          - image: postgres:10.1-alpine
            environment:
              POSTGRES_PASSWORD: password
              POSTGRES_DB: complaint-manager
        steps:
          - checkout
          - run:
              name: Install Dependencies
              command: yarn install
          - run:
              name: Setup DB
              command: yarn setup:db
          - run:
              name: Run Tests
              command: yarn test

    build-and-publish:
        docker:
          - image: docker:stable
        steps:
          - checkout
          - setup_remote_docker
          - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
          - run: docker build --build-arg REACT_ENV=staging -t noipm/complaint-manager-staging:$CIRCLE_SHA1 .
          - run: docker build --build-arg REACT_ENV=production -t noipm/complaint-manager-production:$CIRCLE_SHA1 .
          - run: docker push noipm/complaint-manager-staging:$CIRCLE_SHA1
          - run: docker push noipm/complaint-manager-production:$CIRCLE_SHA1

    deploy-staging:
        docker:
          - image: docker:stable
        steps:
          - setup_remote_docker
          - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
          - run: docker pull noipm/complaint-manager-staging:$CIRCLE_SHA1
          - run:
              name: Migrate and Seed DB
              command: |
                docker run \
                -e NODE_ENV=staging \
                -e DATABASE_USERNAME=$STAGING_DATABASE_USERNAME \
                -e DATABASE_PASS=$STAGING_DATABASE_PASS \
                -e DATABASE_NAME=$STAGING_DATABASE_NAME \
                -e DATABASE_HOST=$STAGING_DATABASE_HOST \
                noipm/complaint-manager-staging:$CIRCLE_SHA1 setup:db

          - run: docker login --username=$HEROKU_USER --password=$HEROKU_API_KEY registry.heroku.com
          - run: docker tag noipm/complaint-manager-staging:$CIRCLE_SHA1 registry.heroku.com/noipm-staging/web
          - run: docker push registry.heroku.com/noipm-staging/web

    ensure-staging-deploy-succeeded:
      docker:
        - image: ubuntu:trusty
      steps:
        - checkout
        - run: scripts/ensure-deploy-succeeded.sh https://noipm-staging.herokuapp.com/health-check

    e2e-testing:
        docker:
          - image: noipm/nightwatch-chrome:latest
        steps:
          - checkout
          - run:
              name: Run E2E tests
              command: cd e2e && nightwatch --env $ENVIRONMENT

    deploy-production:
        docker:
          - image: docker:stable
        steps:
          - setup_remote_docker
          - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
          - run: docker pull noipm/complaint-manager-production:$CIRCLE_SHA1
          - run:
              name: Migrate production database
              command: |
                docker run \
                -e NODE_ENV=production \
                -e DATABASE_USERNAME=$PRODUCTION_DATABASE_USERNAME \
                -e DATABASE_PASS=$PRODUCTION_DATABASE_PASS \
                -e DATABASE_NAME=$PRODUCTION_DATABASE_NAME \
                -e DATABASE_HOST=$PRODUCTION_DATABASE_HOST \
                noipm/complaint-manager-production:$CIRCLE_SHA1 setup:db:prod
          - run: docker login --username=$HEROKU_USER --password=$HEROKU_API_KEY registry.heroku.com
          - run: docker tag noipm/complaint-manager-production:$CIRCLE_SHA1 registry.heroku.com/noipm-production/web
          - run: docker push registry.heroku.com/noipm-production/web

    ensure-production-deploy-succeeded:
      docker:
        - image: alpine:latest
      steps:
        - checkout
        - run: scripts/ensure-deploy-succeeded.sh https://noipm-production.herokuapp.com/health-check

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - test
      - build-and-publish:
          requires:
            - test
      - deploy-staging:
          requires:
            - build-and-publish
      - ensure-staging-deploy-succeeded:
          requires:
            - deploy-staging
      - e2e-testing:
          requires:
            - ensure-staging-deploy-succeeded
      - hold:
          type: approval
          requires:
            - e2e-testing
      - deploy-production:
          requires:
            - hold
      - ensure-production-deploy-succeeded:
          requires:
            - deploy-production
